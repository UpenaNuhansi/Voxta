<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document Audio Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; transition: background 0.8s ease-in-out }
    /* default background: your image */
    body.bg-image {
      background: url('room.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    /* alternate background after audio is generated */
    body.bg-alt {
      background: url('room2.jpg') no-repeat center center fixed;
      background-size: 200% 200%;
    }
  </style>
</head>
<body class="bg-image text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md mx-auto bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl p-8 text-center">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Document Audio Player</h1>
    <p class="text-gray-600 dark:text-gray-300 mb-6">Upload a .txt or .pdf file, then generate and listen to the audio.</p>

    <button id="playButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed">
      <svg id="playIcon" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span id="buttonText">Generate & Play Audio</span>
    </button>

    <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt">
    <label for="fileInput" class="mt-4 w-full inline-block bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-medium py-3 px-6 rounded-xl cursor-pointer transition-colors">
      Upload Document (.txt, .pdf)
    </label>

    <p id="fileStatus" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5">No file uploaded.</p>

    <div id="loadingIndicator" class="hidden mt-4 flex items-center justify-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4zm2 5.29A8 8 0 014 12H0c0 3.04 1.13 5.82 3 7.94l3-2.65z"></path>
      </svg>
      <span class="text-gray-600 dark:text-gray-300">Generating audio, please wait...</span>
    </div>

    <div id="audioContainer" class="mt-6"></div>
    <p id="errorMessage" class="text-red-500 mt-4"></p>
  </div>

  <script>
    const playButton = document.getElementById('playButton')
    const buttonText = document.getElementById('buttonText')
    const playIcon = document.getElementById('playIcon')
    const loadingIndicator = document.getElementById('loadingIndicator')
    const audioContainer = document.getElementById('audioContainer')
    const errorMessage = document.getElementById('errorMessage')
    const fileInput = document.getElementById('fileInput')
    const fileStatus = document.getElementById('fileStatus')

    let documentText = `EXERCISE. Business Processes Management. IS51105. 21CIS0127. Please upload a document to begin.`

    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js'
    }

    fileInput.addEventListener('change', handleFileUpload)

    async function handleFileUpload(event) {
      const file = event.target.files[0]
      if (!file) return

      fileStatus.textContent = `Processing "${file.name}"...`
      errorMessage.textContent = ''
      audioContainer.innerHTML = ''

      try {
        if (file.type === 'application/pdf') {
          documentText = await readPdfFile(file)
        } else if (file.type === 'text/plain') {
          documentText = await readTxtFile(file)
        } else {
          throw new Error('Unsupported file type. Please upload a .txt or .pdf file.')
        }
        fileStatus.textContent = `Ready to play "${file.name}".`
      } catch (error) {
        errorMessage.textContent = `Error reading file: ${error.message}`
        fileStatus.textContent = 'File processing failed.'
        console.error(error)
      }
    }

    function readTxtFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = e => resolve(e.target.result)
        reader.onerror = () => reject(new Error('Failed to read the text file.'))
        reader.readAsText(file)
      })
    }

    async function readPdfFile(file) {
      const reader = new FileReader()
      return new Promise((resolve, reject) => {
        reader.onload = async e => {
          const data = new Uint8Array(e.target.result)
          try {
            const pdf = await pdfjsLib.getDocument({ data }).promise
            let fullText = ''
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i)
              const textContent = await page.getTextContent()
              fullText += textContent.items.map(item => item.str).join(' ') + '\n'
            }
            resolve(fullText)
          } catch (err) {
            reject(new Error('Failed to parse the PDF file.'))
          }
        }
        reader.onerror = () => reject(new Error('Failed to read the PDF file.'))
        reader.readAsArrayBuffer(file)
      })
    }

    function base64ToArrayBuffer(base64) {
      const binaryString = window.atob(base64)
      const len = binaryString.length
      const bytes = new Uint8Array(len)
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i)
      return bytes.buffer
    }

    function pcmToWav(pcmData, sampleRate) {
      const numChannels = 1
      const bitsPerSample = 16
      const byteRate = sampleRate * numChannels * bitsPerSample / 8
      const blockAlign = numChannels * bitsPerSample / 8
      const dataSize = pcmData.length * 2
      const buffer = new ArrayBuffer(44 + dataSize)
      const view = new DataView(buffer)

      writeString(view, 0, 'RIFF')
      view.setUint32(4, 36 + dataSize, true)
      writeString(view, 8, 'WAVE')
      writeString(view, 12, 'fmt ')
      view.setUint32(16, 16, true)
      view.setUint16(20, 1, true)
      view.setUint16(22, numChannels, true)
      view.setUint32(24, sampleRate, true)
      view.setUint32(28, byteRate, true)
      view.setUint16(32, blockAlign, true)
      view.setUint16(34, bitsPerSample, true)
      writeString(view, 36, 'data')
      view.setUint32(40, dataSize, true)

      const pcm16 = new Int16Array(pcmData.buffer, pcmData.byteOffset, pcmData.length)
      for (let i = 0; i < pcm16.length; i++) {
        view.setInt16(44 + i * 2, pcm16[i], true)
      }
      return new Blob([view], { type: 'audio/wav' })
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i))
    }

    // Frontend now calls your proxy, not Google directly
    const apiUrl = 'http://localhost:3000/api/generate-audio'

    playButton.addEventListener('click', async () => {
      playButton.disabled = true
      loadingIndicator.classList.remove('hidden')
      audioContainer.innerHTML = ''
      errorMessage.textContent = ''

      const payload = {
        model: 'gemini-2.5-flash-preview-tts',
        contents: [{ parts: [{ text: `Read the following text clearly and at a moderate pace: ${documentText}` }] }],
        generationConfig: {
          responseModalities: ['AUDIO'],
          speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Kore' } } }
        }
      }

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })

        if (!response.ok) {
          const errorText = await response.text()
          throw new Error(errorText || `HTTP ${response.status}`)
        }

        const result = await response.json()
        const part = result?.candidates?.[0]?.content?.parts?.[0]
        const audioData = part?.inlineData?.data
        const mimeType = part?.inlineData?.mimeType

        if (audioData && mimeType && mimeType.startsWith('audio/')) {
          // switch background to gradient when audio is ready
          document.body.classList.remove('bg-image')
          document.body.classList.add('bg-alt')

          const sampleRateMatch = mimeType.match(/rate=(\d+)/)
          const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000

          const pcmDataBuffer = base64ToArrayBuffer(audioData)
          const pcm16 = new Int16Array(pcmDataBuffer)
          const wavBlob = pcmToWav(pcm16, sampleRate)
          const audioUrl = URL.createObjectURL(wavBlob)

          const audio = new Audio(audioUrl)
          audio.controls = true
          audio.autoplay = true

          audio.onended = () => {
            buttonText.textContent = 'Play Again'
            // switch back to your image when playback ends
            document.body.classList.remove('bg-alt')
            document.body.classList.add('bg-image')
            playIcon.innerHTML = `
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`
          }

          audio.onplaying = () => {
            buttonText.textContent = 'Playing...'
            playIcon.innerHTML = `
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>`
          }

          audioContainer.appendChild(audio)
        } else {
          throw new Error('Invalid audio data received from API.')
        }
      } catch (err) {
        console.error('Error generating audio:', err)
        errorMessage.textContent = `Failed to generate audio. ${err.message}`
      } finally {
        loadingIndicator.classList.add('hidden')
        playButton.disabled = false
      }
    })
  </script>
</body>
</html>
